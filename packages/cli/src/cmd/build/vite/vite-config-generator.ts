/**
 * Generate ephemeral vite.config.ts in .agentuity/.vite/
 * This is the actual config file that Vite uses in dev mode
 */

import { join } from 'node:path';
import { mkdir, writeFile } from 'node:fs/promises';
import type { Logger } from '../../../types';

export interface GenerateViteConfigOptions {
	rootDir: string;
	dev: boolean;
	projectId?: string;
	orgId?: string;
	deploymentId?: string;
	workbenchPath?: string;
	logger: Logger;
}

/**
 * Generate .agentuity/.vite/vite.config.ts
 * This is the config file that Vite will actually use
 */
export async function generateViteConfig(options: GenerateViteConfigOptions): Promise<string> {
	const {
		rootDir,
		dev,
		projectId = '',
		orgId = '',
		deploymentId = '',
		workbenchPath,
		logger,
	} = options;

	const viteDir = join(rootDir, '.agentuity', '.vite');
	const configPath = join(viteDir, 'vite.config.generated.ts');

	// Ensure .vite directory exists
	await mkdir(viteDir, { recursive: true });

	// Generate the config file content
	const code = `// Auto-generated by Agentuity
// DO NOT EDIT - This file is regenerated on every build/dev

import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
${dev ? `import devServer from '@hono/vite-dev-server';` : ''}
import adapter from '@hono/vite-dev-server/bun';
${dev ? '' : `import build from '@hono/vite-build/bun';`}
import { agentuityPlugin, patchPlugin, browserEnvPlugin } from '@agentuity/cli/vite-plugin';
import { createLogger } from '@agentuity/server';
import { readFileSync, existsSync } from 'node:fs';
import { join } from 'node:path';

export default defineConfig(async () => {
	const rootDir = ${JSON.stringify(rootDir)};
	const logger = createLogger('info');
	
	// Load path aliases from tsconfig.json
	const tsconfigPath = join(rootDir, 'tsconfig.json');
	let alias = {};
	if (existsSync(tsconfigPath)) {
		try {
			const tsconfig = JSON.parse(readFileSync(tsconfigPath, 'utf-8'));
			const paths = tsconfig?.compilerOptions?.paths || {};
			alias = Object.fromEntries(
				Object.entries(paths).map(([key, [value]]) => [
					key.replace('/*', ''),
					join(rootDir, value.replace('/*', ''))
				])
			);
		} catch (e) {
			console.warn('Failed to load path aliases from tsconfig.json:', e);
		}
	}

	return {
		base: ${dev ? `'/'` : `(process.env.AGENTUITY_REGION === 'local' || !'${deploymentId}') ? '/' : 'https://static.agentuity.com/${deploymentId}/'`},
		clearScreen: false,
		// Server build doesn't need public files - client build handles those
		publicDir: false,
		resolve: { alias },
		// In dev mode, restrict client env vars for security (server has process.env)
		// In prod server build, empty array allows all (not used since server uses process.env)
		envPrefix: ${dev ? `['VITE_', 'AGENTUITY_PUBLIC_', 'PUBLIC_']` : `[]`},
		${
			dev
				? `server: {
			fs: {
				// Prevent Vite from serving workbench files - let Hono handle them
				deny: ['**/.agentuity/workbench/**'],
			},
			// Proxy all WebSocket upgrade requests to secondary Node.js server
			proxy: {
				'/_agentuity': {
					target: 'http://127.0.0.1:3501',
					ws: true,
					changeOrigin: false,
					configure: (proxy) => {
						logger.debug('[Proxy] Configuring WebSocket proxy for /_agentuity');
						
						proxy.on('proxyReqWs', (_proxyReq, req, _socket, _options, _head) => {
							logger.info(\`[Proxy] WebSocket upgrade - proxying \${req.url} to :3501\`);
							logger.debug(\`[Proxy] Upgrade headers: \${JSON.stringify(req.headers)}\`);
						});
						
						proxy.on('open', (_proxySocket) => {
							logger.info('[Proxy] WebSocket tunnel opened to :3501');
						});
						
						proxy.on('close', (_res, _socket, _head) => {
							logger.info('[Proxy] WebSocket tunnel closed');
						});
						
						proxy.on('error', (err, req, _res) => {
							logger.error(\`[Proxy] WebSocket error on \${req.url}:\`, err.message);
							logger.error(\`[Proxy] Error stack:\`, err.stack);
						});
					},
				},
				'/api': {
					target: 'http://127.0.0.1:3501',
					ws: true,
					changeOrigin: false,
				},
			},
		},`
				: ''
		}
		define: {
			${workbenchPath ? `'import.meta.env.AGENTUITY_PUBLIC_WORKBENCH_PATH': ${JSON.stringify(JSON.stringify(workbenchPath))},` : ''}
			'import.meta.env.AGENTUITY_PUBLIC_HAS_SDK_KEY': ${JSON.stringify(JSON.stringify(process.env.AGENTUITY_SDK_KEY ? 'true' : 'false'))},
			'process.env.NODE_ENV': ${JSON.stringify(JSON.stringify(dev ? 'development' : 'production'))},
		},
		plugins: [
			react(),
			browserEnvPlugin(),
			patchPlugin({
				logger,
				dev: ${dev},
			}),
			agentuityPlugin({
				dev: ${dev},
				rootDir,
				projectId: '${projectId}',
				orgId: '${orgId}',
				deploymentId: '${deploymentId}',
				logLevel: 'info',
			}),
			${
				dev
					? `
			devServer({
				adapter,
				entry: '.agentuity/app.generated.ts',
			}),`
					: `
			build({
				entry: '.agentuity/app.generated.ts',
				outputDir: '.agentuity',
				output: 'app.js',
			}),`
			}
		],
		build: {
			rollupOptions: {
				external: ['vite', '@agentuity/cli'],
				output: {
					inlineDynamicImports: false,
					chunkFileNames: 'server/[name]-[hash].js',
					manualChunks(id) {
						// Split vendor dependencies into separate chunks
						if (id.includes('node_modules')) {
							// Extract package name from node_modules path
							const match = id.match(/node_modules\\/([^/]+)/);
							if (match) {
								const packageName = match[1];
								// Group some common packages together
								if (packageName.startsWith('@agentuity')) {
									return 'vendor-agentuity';
								}
								if (['hono'].includes(packageName)) {
									return 'vendor-hono';
								}
								// Other vendors go to general vendor chunk
								return 'vendor';
							}
						}
					},
				},
				onwarn(warning, warn) {
					// Suppress eval warnings for third-party dependencies (safe in trusted server environment)
					if (warning.code === 'EVAL' && warning.id?.includes('@protobufjs/inquire')) {
						return;
					}
					// Use default warning behavior for other warnings
					warn(warning);
				},
			},
		},
	};
});
`;

	await writeFile(configPath, code, 'utf-8');
	logger.trace('Generated Vite config at %s', configPath);

	return configPath;
}
