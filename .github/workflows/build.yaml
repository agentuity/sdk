name: Build Packages & Test

on:
   push:
      branches:
         - main
   pull_request:

jobs:
   build:
      runs-on: ubuntu-latest
      timeout-minutes: 5
      name: Build
      env:
         AGENTUITY_CLOUD_PROJECT_ID: ${{ vars.AGENTUITY_CLOUD_PROJECT_ID }}
      steps:
         - uses: actions/checkout@v4
         - name: Setup Bun
           uses: oven-sh/setup-bun@v2
         - name: Install dependencies & tooling
           run: |
              set -eou pipefail
              bun install
              bun run build
              CWD=$(pwd)
              cd apps/test-app && bun run build
              cd $CWD
              cd apps/create-agentuity && bun install && bun run build
              cd $CWD
              bun run lint
              bun run typecheck
         - name: Create test-app .env
           run: |
              echo "AGENTUITY_SDK_KEY=${{ secrets.AGENTUITY_SDK_KEY }}" > apps/test-app/.env
              echo "AGENTUITY_CLOUD_PROJECT_ID=${{ env.AGENTUITY_CLOUD_PROJECT_ID }}" >> apps/test-app/.env
         - name: Test
           run: |
              set -eou pipefail
              bun test
              cd apps/test-app && bun run test
         - name: Cleanup .env
           if: always()
           run: rm -f apps/test-app/.env
