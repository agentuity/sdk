name: Package Smoke Test

on:
   push:
      branches:
         - main
   pull_request:

concurrency:
   group: ${{ github.workflow }}-${{ github.ref }}
   cancel-in-progress: true

env:
   CI: true

jobs:
   smoke-test:
      runs-on: blacksmith-2vcpu-ubuntu-2404
      timeout-minutes: 15
      name: Package Installation & Usage Test
      steps:
         - uses: actions/checkout@v4

         - name: Setup Bun
           uses: oven-sh/setup-bun@v2

         - name: Install dependencies
           run: bun install

         - name: Run package smoke test
           run: bash scripts/test-package-install.sh

   integration-test:
      runs-on: blacksmith-2vcpu-ubuntu-2404
      timeout-minutes: 10
      name: SDK Integration Test Suite
      env:
         AGENTUITY_API_URL: https://api-v1.agentuity.com
         AGENTUITY_USER_ID: ${{ vars.AGENTUITY_USER_ID }}
         AGENTUITY_REGION: usc
      steps:
         - uses: actions/checkout@v4

         - name: Setup Bun
           uses: oven-sh/setup-bun@v2

         - name: Install dependencies
           run: bun install

         - name: Prepare SDK for testing
           run: bash scripts/prepare-sdk-for-testing.sh

         - name: Install SDK in integration-suite
           run: bash scripts/install-sdk-tarballs.sh apps/testing/integration-suite

         - name: Setup test credentials
           run: |
              # Generate CLI API key for authentication
              APIKEY=$(curl $AGENTUITY_API_URL/cli/auth/short-token -H 'Content-Type: application/json' --data "{\"secret\":\"${{ secrets.AGENTUITY_APITOKEN_SHARED_SECRET }}\",\"userId\":\"${{ env.AGENTUITY_USER_ID }}\"}" | jq -r '.data.apiKey')
              echo "::add-mask::${APIKEY}"
              echo "AGENTUITY_CLI_API_KEY=${APIKEY}" >> $GITHUB_ENV

              # Set SDK key for integration-suite tests
              echo "AGENTUITY_SDK_KEY=${{ secrets.INTEGRATION_SUITE_AGENTUITY_SDK_KEY }}" >> $GITHUB_ENV

              # Set OpenAI API key for embedding operations
              echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV

         - name: Run integration test suite
           run: bash apps/testing/integration-suite/scripts/ci-test.sh

   cloud-deployment-test:
      runs-on: blacksmith-2vcpu-ubuntu-2404
      timeout-minutes: 15
      name: Cloud Deployment Tests
      env:
         AGENTUITY_API_URL: https://api-v1.agentuity.com
         AGENTUITY_APP_URL: https://app-v1.agentuity.com
         AGENTUITY_TRANSPORT_URL: https://catalyst-usc.agentuity.cloud
         AGENTUITY_CATALYST_URL: https://catalyst-usc.agentuity.cloud
         AGENTUITY_STREAM_URL: https://streams-usc.agentuity.cloud
         AGENTUITY_KEYVALUE_URL: https://catalyst-usc.agentuity.cloud
         AGENTUITY_OBJECTSTORE_URL: https://catalyst-usc.agentuity.cloud
         AGENTUITY_VECTOR_URL: https://catalyst-usc.agentuity.cloud
         AGENTUITY_LOG_LEVEL: error
         AGENTUITY_REGION: usc
         AGENTUITY_USER_ID: ${{ vars.AGENTUITY_USER_ID }}
      steps:
         - uses: actions/checkout@v4

         - name: Setup Bun
           uses: oven-sh/setup-bun@v2

         - name: Install dependencies
           run: bun install

         - name: Prepare SDK for testing
           run: bash scripts/prepare-sdk-for-testing.sh

         - name: Install SDK in cloud-deployment
           run: bash scripts/install-sdk-tarballs.sh apps/testing/cloud-deployment

         - name: Setup test credentials
           run: |
              # Generate CLI API key for cloud operations
              APIKEY=$(curl $AGENTUITY_API_URL/cli/auth/short-token -H 'Content-Type: application/json' --data "{\"secret\":\"${{ secrets.AGENTUITY_APITOKEN_SHARED_SECRET }}\",\"userId\":\"${{ env.AGENTUITY_USER_ID }}\"}" | jq -r '.data.apiKey')
              echo "::add-mask::${APIKEY}"
              echo "AGENTUITY_CLI_API_KEY=${APIKEY}" >> $GITHUB_ENV

              # Set SDK key for runtime operations
              echo "AGENTUITY_SDK_KEY=${{ secrets.CLOUD_DEPLOYMENT_AGENTUITY_SDK_KEY }}" >> $GITHUB_ENV

              # Set OpenAI API key for embedding operations
              echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV

         - name: Create .env file for app runtime
           run: |
              cd apps/testing/cloud-deployment
              cat > .env << EOF
              AGENTUITY_SDK_KEY=${{ secrets.CLOUD_DEPLOYMENT_AGENTUITY_SDK_KEY }}
              OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
              AGENTUITY_API_URL=$AGENTUITY_API_URL
              AGENTUITY_APP_URL=$AGENTUITY_APP_URL
              AGENTUITY_TRANSPORT_URL=$AGENTUITY_TRANSPORT_URL
              AGENTUITY_CATALYST_URL=$AGENTUITY_CATALYST_URL
              AGENTUITY_STREAM_URL=$AGENTUITY_STREAM_URL
              AGENTUITY_KEYVALUE_URL=$AGENTUITY_KEYVALUE_URL
              AGENTUITY_OBJECTSTORE_URL=$AGENTUITY_OBJECTSTORE_URL
              AGENTUITY_VECTOR_URL=$AGENTUITY_VECTOR_URL
              AGENTUITY_LOG_LEVEL=$AGENTUITY_LOG_LEVEL
              AGENTUITY_REGION=$AGENTUITY_REGION
              EOF

         - name: Run cloud deployment tests
           run: bash scripts/test-cloud-deployment.sh

         - name: Cleanup
           if: always()
           run: rm -rf apps/testing/cloud-deployment/.env

   template-integration-test:
      runs-on: blacksmith-2vcpu-ubuntu-2404
      timeout-minutes: 30
      name: Template Integration Tests
      steps:
         - uses: actions/checkout@v4

         - name: Setup Bun
           uses: oven-sh/setup-bun@v2

         - name: Install dependencies
           run: bun install

         - name: Build packages
           run: bun run build

         - name: Run template integration tests
           run: bun scripts/test-templates.ts --skip-outdated

   playwright-e2e-test:
      runs-on: blacksmith-4vcpu-ubuntu-2204
      timeout-minutes: 10
      name: Playwright E2E Smoke Test
      steps:
         - uses: actions/checkout@v4

         - name: Setup Bun
           uses: oven-sh/setup-bun@v2

         - name: Install dependencies
           run: bun install

         - name: Install Playwright browsers
           run: bunx playwright install --with-deps chromium

         - name: Prepare SDK for testing
           run: bash scripts/prepare-sdk-for-testing.sh

         - name: Install SDK in e2e-web
           run: bash scripts/install-sdk-tarballs.sh apps/testing/e2e-web

         - name: Run Playwright E2E tests
           run: bash scripts/test-e2e.sh

         - name: Upload Playwright report
           uses: actions/upload-artifact@v4
           if: always()
           with:
              name: playwright-report
              path: playwright-report/
              retention-days: 7
