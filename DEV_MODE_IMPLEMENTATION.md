# Dev Mode Implementation - Vite + Hono Integration

## Summary

Implemented dev mode using generated entry file that integrates with @hono/vite-dev-server while keeping user's `app.ts` clean.

## Architecture

### Flow Diagram

```
agentuity dev
    ↓
Vite Plugin (buildStart hook)
    ↓
Generates: .agentuity/agentuity_app.generated.js
    ├── Creates Hono router
    ├── Sets globalThis.__AGENTUITY_ROUTER__
    ├── Imports user's app.ts (triggers createApp)
    ├── Mounts discovered API routes
    ├── Adds web routes (dev HTML with Vite HMR)
    └── Exports router
    ↓
vite.config.ts
    ↓
devServer({ entry: '.agentuity/agentuity_app.generated.js' })
    ↓
@hono/vite-dev-server runs the generated entry
    ↓
User's app.ts executes:
    createApp() finds global router
    ↓
    Configures middleware on global router
    ↓
Returns to generated entry
    ↓
Routes mounted AFTER middleware
    ↓
Vite dev server serves:
    - API routes via Hono
    - React app via Vite HMR
```

## Implementation Details

### 1. Generated Entry File (.agentuity/agentuity_app.generated.js)

**Location:** Generated by plugin in `buildStart` hook

**Purpose:** Bootstrap file that Vite dev server runs

**Contents:**

```typescript
import { createRouter } from '@agentuity/runtime';
import { serveStatic } from 'hono/bun';
import apiRouter from '../src/api/index.js';

const app = createRouter();
globalThis.__AGENTUITY_ROUTER__ = app;

// Import user's app.ts (runs createApp with middleware setup)
await import('../app.ts');

// Mount routes AFTER middleware
app.route('/api', apiRouter);

// Web routes
if (import.meta.env.PROD) {
	app.use('/assets/*', serveStatic({ root: './.agentuity/client' }));
	app.get('/', serveStatic({ path: './.agentuity/client/index.html' }));
} else {
	app.get('/', (c) => c.html(`... Vite HMR HTML ...`));
}

export default app;
```

### 2. User's app.ts (Clean Template)

**Location:** `templates/_base/app.ts`

**User sees:**

```typescript
import { createApp } from '@agentuity/runtime';

const { server, logger } = await createApp({
	setup: async () => {
		// User initialization
	},
	shutdown: async (state) => {
		// User cleanup
	},
});

logger.debug('Running %s', server.url);
```

**What happens:**

- `createApp()` checks for `globalThis.__AGENTUITY_ROUTER__`
- If found (dev mode), uses that router
- If not found (production), creates new router
- Configures middleware on the router
- Returns { server, logger }

### 3. Runtime Changes

**File:** `packages/runtime/src/app.ts`

```typescript
export async function createApp<TAppState = Record<string, never>>(
	config?: AppConfig<TAppState>
): Promise<App<TAppState>> {
	// Check for global router (set by generated entry in dev mode)
	const router = (globalThis as any).__AGENTUITY_ROUTER__ || new Hono<Env<TAppState>>();

	// Rest of createApp logic...
	const [server, state] = await createServer<TAppState>(router, initializer, config);
	return new App(state, router, server);
}
```

### 4. Vite Configuration

**File:** `templates/_base/vite.config.ts`

```typescript
export default defineConfig(async () => {
	return {
		plugins: [
			react(),
			devServer({
				entry: '.agentuity/agentuity_app.generated.js', // Generated entry!
				adapter,
			}),
		],
		server: {
			port: parseInt(process.env.PORT || '3500'),
		},
	};
});
```

### 5. Plugin Changes

**File:** `packages/cli/src/vite-plugin/index.ts`

**New function:** `generateEntryFile()`

- Called in `buildStart` hook (dev mode only)
- Discovers routes from `src/api/`
- Generates complete entry file
- Writes to `.agentuity/agentuity_app.generated.js`

## Key Benefits

1. ✅ **Clean user code** - app.ts stays simple and readable
2. ✅ **No code injection** - all generated code in separate file
3. ✅ **Middleware ordering** - middleware configured before routes mounted
4. ✅ **Works with @hono/vite-dev-server** - standard Vite plugin integration
5. ✅ **Single dev server** - one URL for both API and web
6. ✅ **HMR enabled** - both client (React) and server (Hono) hot reload

## What's Next

- [ ] Test dev mode with a real project
- [ ] Verify API routes work
- [ ] Verify web routes serve Vite HMR correctly
- [ ] Implement production mode (different approach - inject into app.ts)
- [ ] Test agent setup callbacks run correctly
- [ ] Verify middleware ordering is correct

## Production Mode (TODO)

Production will use a different approach:

- Plugin will inject routes directly into app.ts via transform hook
- No global router - createApp creates new router
- Build output is single `.agentuity/app.js` file

This will be implemented after dev mode is verified working.
