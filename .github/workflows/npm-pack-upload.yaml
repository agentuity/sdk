name: NPM Pack & Upload

on:
   push:
      branches:
         - main
   pull_request:

permissions:
   contents: read
   pull-requests: write

concurrency:
   group: ${{ github.workflow }}-${{ github.ref }}
   cancel-in-progress: true

env:
   CI: true
   AWS_ACCESS_KEY_ID: ${{ vars.AWS_ACCESS_KEY_ID }}
   AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
   AWS_ENDPOINT_URL_S3: ${{ vars.AWS_ENDPOINT_URL_S3 }}
   AWS_ENDPOINT_URL_IAM: ${{ vars.AWS_ENDPOINT_URL_IAM }}
   AWS_REGION: ${{ vars.AWS_REGION }}

jobs:
   pack-and-upload:
      runs-on: blacksmith-4vcpu-ubuntu-2204
      timeout-minutes: 15
      name: Pack & Upload
      steps:
         - uses: actions/checkout@v4
           with:
              ref: ${{ github.event.pull_request.head.sha || github.sha }}

         - name: Setup Bun
           uses: oven-sh/setup-bun@v2

         - name: Install dependencies
           run: bun install

         - name: Pack and Upload
           id: pack
           run: bun scripts/npm-pack-upload.ts

         - name: Comment on PR
           if: github.event_name == 'pull_request'
           uses: actions/github-script@v7
           with:
              script: |
                 const version = '${{ steps.pack.outputs.prerelease_version }}';
                 const packagesJson = ${{ steps.pack.outputs.packages_json }};
                 const baseUrl = `https://agentuity-sdk-objects.t3.storage.dev/npm/${version}`;

                 let table = '| Package | Version | URL |\n| --- | --- | --- |\n';
                 for (const pkg of packagesJson) {
                   const url = `${baseUrl}/${pkg.tarball}`;
                   table += `| \`${pkg.name}\` | \`${version}\` | ${url} |\n`;
                 }

                 // Build dependencies object with all packages
                 const deps = {};
                 for (const pkg of packagesJson) {
                   deps[pkg.name] = `${baseUrl}/${pkg.tarball}`;
                 }
                 const depsJson = JSON.stringify({ dependencies: deps }, null, 2);

                 const body = `## ðŸ“¦ Canary Packages Published

                 ${table}

                 ### Installation

                 Add to your \`package.json\`:

                 \`\`\`json
                 ${depsJson}
                 \`\`\`

                 Or install directly:

                 \`\`\`bash
                 bun add ${packagesJson.map(pkg => `${baseUrl}/${pkg.tarball}`).join(' ')}
                 \`\`\`
                 `;

                 // Find existing comment
                 const { data: comments } = await github.rest.issues.listComments({
                   owner: context.repo.owner,
                   repo: context.repo.repo,
                   issue_number: context.issue.number,
                 });

                 const botComment = comments.find(c =>
                   c.user.type === 'Bot' && c.body.includes('ðŸ“¦ Canary Packages Published')
                 );

                 if (botComment) {
                   await github.rest.issues.updateComment({
                     owner: context.repo.owner,
                     repo: context.repo.repo,
                     comment_id: botComment.id,
                     body: body,
                   });
                 } else {
                   await github.rest.issues.createComment({
                     owner: context.repo.owner,
                     repo: context.repo.repo,
                     issue_number: context.issue.number,
                     body: body,
                   });
                 }
