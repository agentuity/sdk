// @generated
// Auto-generated by Agentuity
// DO NOT EDIT - This file is regenerated on every build

import type { Context } from 'hono';
import {
	createRouter,
	createWebSessionMiddleware,
	getOrganizationId,
	getProjectId,
	isDevMode as runtimeIsDevMode,
} from '@agentuity/runtime';
import type { AnalyticsConfig } from './analytics-config';

// The beacon script - pre-built from @agentuity/frontend/src/analytics/beacon-standalone.ts
const BEACON_SCRIPT = "(()=>{(function(){let W=window,V=document,Z=W.__AGENTUITY_ANALYTICS__;if(!Z||!Z.enabled)return;let M=W;if(Z.isDevmode)console.debug(\"[Agentuity Analytics] Script loaded, init flag:\",M.__AGENTUITY_BEACON_INIT__,\"path:\",location.pathname);if(M.__AGENTUITY_BEACON_INIT__){if(Z.isDevmode)console.debug(\"[Agentuity Analytics] Already initialized, skipping\");return}M.__AGENTUITY_BEACON_INIT__=!0;let G=Z,J=null,_=!1,$=Date.now(),A=\"\",C={},j={id:\"\",timestamp:0,timezone_offset:0,url:\"\",path:\"\",referrer:\"\",title:\"\",screen_width:0,screen_height:0,viewport_width:0,viewport_height:0,device_pixel_ratio:1,user_agent:\"\",language:\"\",scroll_depth:0,time_on_page:0,scroll_events:[],custom_events:[]};function L(){return crypto.randomUUID?crypto.randomUUID():`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function F(){let q=new URLSearchParams(location.search),x={};return[\"utm_source\",\"utm_medium\",\"utm_campaign\",\"utm_term\",\"utm_content\"].forEach((B)=>{let K=q.get(B);if(K)x[B]=K}),x}function U(q){if(!q)return\"\";try{let x=new URL(q);return x.origin+x.pathname}catch{return q.split(\"?\")[0]}}function O(){j.id=L(),j.timestamp=Date.now(),j.timezone_offset=new Date().getTimezoneOffset(),j.url=U(location.href),j.path=location.pathname,j.referrer=U(V.referrer),j.title=V.title||\"\",j.screen_width=screen.width||0,j.screen_height=screen.height||0,j.viewport_width=innerWidth||0,j.viewport_height=innerHeight||0,j.device_pixel_ratio=devicePixelRatio||1,j.user_agent=navigator.userAgent||\"\",j.language=navigator.language||\"\";let q=F();for(let x in q)j[x]=q[x];if(j.scroll_events=[],j.custom_events=[],j.scroll_depth=0,j.fcp=0,j.lcp=0,j.cls=0,j.inp=0,_=!1,$=Date.now(),typeof performance<\"u\"&&performance.getEntriesByType){let x=performance.getEntriesByType(\"navigation\")[0];if(x)j.load_time=Math.round(x.loadEventEnd-x.startTime),j.dom_ready=Math.round(x.domContentLoadedEventEnd-x.startTime),j.ttfb=Math.round(x.responseStart-x.requestStart)}if(G.isDevmode)console.debug(\"[Agentuity Analytics] Session started (full init):\",j.id)}function N(){if(j.id=L(),j.timestamp=Date.now(),j.scroll_events=[],j.custom_events=[],j.scroll_depth=0,j.time_on_page=0,_=!1,$=Date.now(),G.isDevmode)console.debug(\"[Agentuity Analytics] Session started (soft reset):\",j.id)}fetch(\"https://agentuity.sh/location\").then((q)=>q.json()).then((q)=>{J=q;try{sessionStorage.setItem(\"agentuity_geo\",JSON.stringify(q))}catch{}}).catch(()=>{try{let q=sessionStorage.getItem(\"agentuity_geo\");if(q)J=JSON.parse(q)}catch{}});try{let q=sessionStorage.getItem(\"agentuity_geo\");if(q)J=JSON.parse(q)}catch{}function H(){return W.__AGENTUITY_SESSION__}function z(q=!1){if(_&&!q){if(G.isDevmode)console.debug(\"[Agentuity Analytics] send() skipped - already sent\");return}if(G.sampleRate!==void 0&&G.sampleRate<1&&Math.random()>G.sampleRate)return;if(_=!0,j.time_on_page=Date.now()-$,J){if(j.country=J.country||\"\",J.country_latitude)j.country_latitude=parseFloat(String(J.country_latitude));if(J.country_longitude)j.country_longitude=parseFloat(String(J.country_longitude));if(j.region=J.region||\"\",J.region_latitude)j.region_latitude=parseFloat(String(J.region_latitude));if(J.region_longitude)j.region_longitude=parseFloat(String(J.region_longitude));if(j.city=J.city||\"\",J.city_latitude)j.city_latitude=parseFloat(String(J.city_latitude));if(J.city_longitude)j.city_longitude=parseFloat(String(J.city_longitude));if(j.timezone=J.timezone||\"\",J.latitude)j.latitude=parseFloat(String(J.latitude));if(J.longitude)j.longitude=parseFloat(String(J.longitude))}if(j.cls)j.cls=Math.round(j.cls*1000)/1000;let x=H(),B=localStorage.getItem(\"agentuity_visitor_id\")||\"vid_\"+L();try{localStorage.setItem(\"agentuity_visitor_id\",B)}catch{}let K={org_id:G.orgId,project_id:G.projectId,thread_id:x?.threadId||\"\",visitor_id:B,user_id:A,user_traits:C,is_devmode:G.isDevmode,pageview:j};try{sessionStorage.removeItem(\"agentuity_pending_pageview\")}catch{}if(G.isDevmode){console.debug(\"[Agentuity Analytics]\",JSON.stringify(K,null,2));return}let X=JSON.stringify(K);if(navigator.sendBeacon)navigator.sendBeacon(\"/_agentuity/webanalytics/collect\",X);else fetch(\"/_agentuity/webanalytics/collect\",{method:\"POST\",body:X,keepalive:!0}).catch(()=>{})}if(V.addEventListener(\"visibilitychange\",()=>{if(G.isDevmode)console.debug(\"[Agentuity Analytics] visibilitychange:\",V.visibilityState,\"sent:\",_);if(V.visibilityState===\"hidden\")z();else if(V.visibilityState===\"visible\")N()}),W.addEventListener(\"pagehide\",()=>{if(G.isDevmode){console.debug(\"[Agentuity Analytics] pagehide event\");try{sessionStorage.setItem(\"agentuity_last_event\",`pagehide:${Date.now()}:${j.path}`)}catch{}}z()}),W.addEventListener(\"beforeunload\",()=>{if(G.isDevmode){console.debug(\"[Agentuity Analytics] beforeunload event\");try{sessionStorage.setItem(\"agentuity_last_event\",`beforeunload:${Date.now()}:${j.path}`)}catch{}}z()}),G.isDevmode)try{let q=sessionStorage.getItem(\"agentuity_last_event\");if(q)console.debug(\"[Agentuity Analytics] Previous page event:\",q),sessionStorage.removeItem(\"agentuity_last_event\")}catch{}try{let q=sessionStorage.getItem(\"agentuity_pending_pageview\");if(q){sessionStorage.removeItem(\"agentuity_pending_pageview\");let x=JSON.parse(q);if(x.pageview?.path!==location.pathname)if(G.isDevmode)console.debug(\"[Agentuity Analytics] Sending unsent data from previous page:\",x.pageview?.path),console.debug(\"[Agentuity Analytics]\",JSON.stringify(x,null,2));else{let B=JSON.stringify(x);if(navigator.sendBeacon)navigator.sendBeacon(\"/_agentuity/webanalytics/collect\",B)}}}catch{}function Q(){try{j.time_on_page=Date.now()-$;let q=H(),x=localStorage.getItem(\"agentuity_visitor_id\")||\"vid_\"+L(),B={org_id:G.orgId,project_id:G.projectId,thread_id:q?.threadId||\"\",visitor_id:x,user_id:A,user_traits:C,is_devmode:G.isDevmode,pageview:{...j}};sessionStorage.setItem(\"agentuity_pending_pageview\",JSON.stringify(B))}catch{}}if(setInterval(Q,2000),V.addEventListener(\"click\",Q,{passive:!0}),V.addEventListener(\"scroll\",Q,{passive:!0,once:!0}),G.isDevmode)console.debug(\"[Agentuity Analytics] Beacon initialized, visibility:\",V.visibilityState);if(G.trackScroll!==!1){let x=function(){let B=W.scrollY||V.documentElement.scrollTop,K=V.documentElement.scrollHeight-V.documentElement.clientHeight;return K<=0?100:Math.min(100,Math.round(B/K*100))};var T=x;let q=new Set;W.addEventListener(\"scroll\",()=>{let B=x();if(B>j.scroll_depth)j.scroll_depth=B;[25,50,75,100].forEach((K)=>{if(B>=K&&!q.has(K))q.add(K),j.scroll_events.push({depth:K,timestamp:Date.now()-$})})},{passive:!0})}if(G.trackWebVitals!==!1&&typeof PerformanceObserver<\"u\"){try{let q=new PerformanceObserver((x)=>{x.getEntries().forEach((B)=>{if(B.name===\"first-contentful-paint\")j.fcp=Math.round(B.startTime),q.disconnect()})});q.observe({type:\"paint\",buffered:!0})}catch{}try{new PerformanceObserver((q)=>{let x=q.getEntries();if(x.length)j.lcp=Math.round(x[x.length-1].startTime)}).observe({type:\"largest-contentful-paint\",buffered:!0})}catch{}try{new PerformanceObserver((q)=>{q.getEntries().forEach((x)=>{let B=x;if(!B.hadRecentInput&&B.value)j.cls=(j.cls||0)+B.value})}).observe({type:\"layout-shift\",buffered:!0})}catch{}try{new PerformanceObserver((q)=>{q.getEntries().forEach((x)=>{let B=x;if(B.duration&&B.duration>(j.inp||0))j.inp=Math.round(B.duration)})}).observe({type:\"event\",buffered:!0})}catch{}}if(G.trackSPANavigation!==!1){let X=function(){let Y=location.pathname+location.search;if(Y!==B){if(G.isDevmode)console.debug(\"[Agentuity Analytics] SPA navigation:\",B,\"->\",Y);z(!0),B=Y,K=location.href,O()}};var D=X;let{pushState:q,replaceState:x}=history,B=location.pathname+location.search,K=location.href;if(G.isDevmode)console.debug(\"[Agentuity Analytics] SPA tracking enabled, initial path:\",B);history.pushState=function(...Y){q.apply(this,Y),setTimeout(X,0)},history.replaceState=function(...Y){x.apply(this,Y),setTimeout(X,0)},W.addEventListener(\"popstate\",X),setInterval(()=>{if(location.href!==K)K=location.href,X()},200)}if(G.trackClicks!==!1)V.addEventListener(\"click\",(q)=>{let x=q.target;if(!x)return;let B=x.closest(\"[data-analytics]\");if(!B)return;if(j.custom_events.length<1000)j.custom_events.push({timestamp:Date.now(),name:\"click:\"+B.getAttribute(\"data-analytics\"),data:\"\"})},!0);if(G.trackErrors!==!1)W.addEventListener(\"error\",(q)=>{if(j.custom_events.length<1000)j.custom_events.push({timestamp:Date.now(),name:\"error:js_error\",data:JSON.stringify({message:q.message||\"Unknown\",filename:q.filename||\"\",lineno:q.lineno||0})})}),W.addEventListener(\"unhandledrejection\",(q)=>{if(j.custom_events.length<1000)j.custom_events.push({timestamp:Date.now(),name:\"error:unhandled_rejection\",data:JSON.stringify({message:q.reason instanceof Error?q.reason.message:String(q.reason)})})});if(V.readyState===\"complete\")O();else W.addEventListener(\"load\",O);W.agentuityAnalytics={track(q,x){if(j.custom_events.length<1000)j.custom_events.push({timestamp:Date.now(),name:q,data:x?JSON.stringify(x):\"\"})},identify(q,x){if(A=q,x){C={};for(let[B,K]of Object.entries(x))C[B]=String(K)}},flush:()=>z(!0)}})();})();\n";

// Inject analytics config and script into HTML
// Note: Only static config is injected (org, project, devmode, tracking options)
// Session and thread IDs are read from cookies by the beacon script
export function injectAnalytics(html: string, analyticsConfig: AnalyticsConfig): string {
	if (!analyticsConfig.enabled) return html;

	const orgId = getOrganizationId() || '';
	const projectId = getProjectId() || '';
	const isDevmode = runtimeIsDevMode();

	// Only include static config - session/thread come from cookies
	const pageConfig = {
		...analyticsConfig,
		orgId,
		projectId,
		isDevmode,
	};

	const configScript = `<script>window.__AGENTUITY_ANALYTICS__=${JSON.stringify(pageConfig)};</script>`;
	// Session script sets cookies and window.__AGENTUITY_SESSION__ (dynamic, not cached)
	const sessionScript = '<script src="/_agentuity/webanalytics/session.js" async></script>';
	// Beacon script - must be sync (not async/defer) to patch history API before the router loads
	const beaconScript = '<script src="/_agentuity/webanalytics/analytics.js"></script>';
	const injection = configScript + sessionScript + beaconScript;

	// Inject before </head> or at start of <body>
	if (html.includes('</head>')) {
		return html.replace('</head>', injection + '</head>');
	}
	if (html.includes('<body')) {
		return html.replace(/<body([^>]*)>/, `<body$1>${injection}`);
	}
	return injection + html;
}

// Serve analytics routes
export function registerAnalyticsRoutes(app: ReturnType<typeof createRouter>): void {
	// Dynamic thread config script - sets cookie and returns thread ID
	// Web analytics only tracks thread ID, not session ID (to avoid polluting sessions table)
	// This endpoint is NOT cached - it generates unique data per request
	app.get('/_agentuity/webanalytics/session.js', createWebSessionMiddleware(), async (c: Context) => {
		// Read from context (cookies aren't readable until the next request)
		const threadId = c.get('_webThreadId') || '';

		// Use JSON.stringify to safely escape threadId and prevent XSS/injection
		const sessionData = JSON.stringify({ threadId });
		const sessionScript = `window.__AGENTUITY_SESSION__=${sessionData};`;

		return new Response(sessionScript, {
			headers: {
				'Content-Type': 'application/javascript; charset=utf-8',
				'Cache-Control': 'no-store, no-cache, must-revalidate',
			},
		});
	});

	// Static beacon script - can be cached
	app.get('/_agentuity/webanalytics/analytics.js', async (c: Context) => {
		return new Response(BEACON_SCRIPT, {
			headers: {
				'Content-Type': 'application/javascript; charset=utf-8',
				'Cache-Control': 'public, max-age=3600',
			},
		});
	});
}
