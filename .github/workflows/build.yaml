name: Build Packages & Test

on:
   push:
      branches:
         - main
   pull_request:

concurrency:
   group: ${{ github.workflow }}-${{ github.ref }}
   cancel-in-progress: false

env:
   CI: true
   AGENTUITY_API_URL: https://api-v1.agentuity.com
   AGENTUITY_APP_URL: https://app-v1.agentuity.com
   AGENTUITY_TRANSPORT_URL: https://catalyst-usc.agentuity.cloud
   AGENTUITY_CATALYST_URL: https://catalyst-usc.agentuity.cloud
   AGENTUITY_STREAM_URL: https://streams-usc.agentuity.cloud
   AGENTUITY_KEYVALUE_URL: https://catalyst-usc.agentuity.cloud
   AGENTUITY_OBJECTSTORE_URL: https://catalyst-usc.agentuity.cloud
   AGENTUITY_VECTOR_URL: https://catalyst-usc.agentuity.cloud
   AGENTUITY_LOG_LEVEL: trace
   AGENTUITY_REGION: usc

jobs:
   build:
      runs-on: blacksmith-4vcpu-ubuntu-2204
      timeout-minutes: 15
      name: Build
      env:
         AGENTUITY_CLOUD_PROJECT_ID: ${{ vars.AGENTUITY_CLOUD_PROJECT_ID }}
         AGENTUITY_USER_ID: ${{ vars.AGENTUITY_USER_ID }}
         AGENTUITY_CLOUD_ORG_ID: ${{ vars.AGENTUITY_CLOUD_ORG_ID }}
      steps:
         - uses: actions/checkout@v4
         - name: Setup Bun
           uses: oven-sh/setup-bun@v2
         - name: Install dependencies
           run: |
              set -eou pipefail
              bun install
         - name: Setup test credentials
           run: |
              # Generate CLI API key for whoami command
              APIKEY=$(curl $AGENTUITY_API_URL/cli/auth/short-token -H 'Content-Type: application/json' --data "{\"secret\":\"${{ secrets.AGENTUITY_APITOKEN_SHARED_SECRET }}\",\"userId\":\"${{ env.AGENTUITY_USER_ID }}\"}" | jq -r '.data.apiKey')
              echo "AGENTUITY_CLI_API_KEY=${APIKEY}" >> $GITHUB_ENV

              # Set SDK key for integration-suite tests
              echo "AGENTUITY_SDK_KEY=${{ secrets.AGENTUITY_SDK_KEY }}" >> $GITHUB_ENV

              # Set OpenAI API key for embedding operations
              echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV
         - name: Build and Test
           timeout-minutes: 15
           run: |
              set -eou pipefail
              bun run build
              bun run whoami
              ./packages/cli/bin/cli.ts profile show --json
              bun all
         - name: Test Upgrade Command
           timeout-minutes: 5
           run: |
              set -eou pipefail
              # Build executables for testing
              cd packages/cli
              bun run build
              ./scripts/build-executables.ts --skip-sign
              
              # Test that upgrade command is available in compiled binary
              ./dist/bin/agentuity-linux-x64 --help | grep -q "upgrade" || (echo "ERROR: upgrade command not found in binary help" && exit 1)
              
              # Test that upgrade command is NOT available when running via bun
              ./bin/cli.ts --help | grep -q "upgrade" && (echo "ERROR: upgrade command should not be in bun help" && exit 1) || true
              
              # Test upgrade --force (will fail at network fetch but should get that far)
              # Set AGENTUITY_SKIP_VERSION_CHECK to bypass the auto-check on startup
              AGENTUITY_SKIP_VERSION_CHECK=1 ./dist/bin/agentuity-linux-x64 upgrade --force 2>&1 | grep -q "Checking for updates" || (echo "ERROR: upgrade command didn't run" && exit 1)
              
              echo "âœ“ Upgrade command tests passed"
         - name: Cleanup
           if: always()
           run: rm -f apps/testing/integration-suite/.env
