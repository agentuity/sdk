#!/usr/bin/env bash
set -euo pipefail

# Ensure we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
	echo "âŒ Error: Not a git repository"
	exit 1
fi

# Validate required dependencies
command -v bun >/dev/null 2>&1 || { echo "âŒ Error: bun is required but not installed."; exit 1; }
command -v git >/dev/null 2>&1 || { echo "âŒ Error: git is required but not installed."; exit 1; }
command -v gh >/dev/null 2>&1 || echo "âš ï¸  Warning: gh CLI not found. You'll need to create the PR manually."

echo "ğŸš€ Running bun all to validate project..."
bun all

if [[ ! $(git status --porcelain) ]]; then
	echo "âœ… No changes to commit. Everything is clean!"
	exit 0
fi

CURRENT_BRANCH=$(git branch --show-current)

if [[ "$CURRENT_BRANCH" == "main" ]]; then
	BRANCH_NAME="auto/$(date +%Y%m%d-%H%M%S)-updates"
	echo "ğŸ“Œ Creating new branch: $BRANCH_NAME"
	git switch -c "$BRANCH_NAME"
fi

echo ""
echo "ğŸ“ Analyzing changes for commit message..."
echo ""
if git diff --cached --quiet; then
	echo "ğŸ“Š Unstaged changes:"
	git diff --stat
else
	echo "ğŸ“Š Staged changes:"
	git diff --cached --stat
	if ! git diff --quiet; then
		echo ""
		echo "âš ï¸  You also have unstaged changes:"
		git diff --stat
	fi
fi
echo ""
echo "---"
echo ""
if git diff --cached --quiet; then
	git diff
else
	git diff --cached
	if ! git diff --quiet; then
		echo ""
		echo "--- Unstaged changes below ---"
		echo ""
		git diff
	fi
fi
echo ""
echo "---"
echo "Please analyze the above changes and:"
echo "1. Stage all changes"
echo "2. Create a detailed, meaningful commit message following conventional commits format"
echo "3. Check if coderabbit CLI is available (command: coderabbit)"
echo "4. If coderabbit is available, request a review and wait for results"
echo "5. If review comes back with suggestions, evaluate high-impact/low-risk changes and apply them"
echo "6. Create a GitHub PR using 'gh pr create' with a detailed description"
echo ""
echo "Let's ship this! ğŸš¢"
